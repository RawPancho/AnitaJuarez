<!DOCTYPE html>
<html>
<head>
  <title>Acta Laboral by Anita Juarez v1.2</title>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

</head>
<body class="body">

  <div id="flash-message" class="flash-hidden"></div>

  <div class="divisionPrincipal" >
    
    <strong>Cuaderno de Acta byAnitaJuarez</strong>
    <br>

    <!--Autentificacion-->
    <button id="authorize_button" class="spaced btn btn-primary" onclick="handleAuthClick()">Autorizar</button>
    <button id="signout_button" class="spaced btn btn-primary" onclick="handleSignoutClick()">Desvincular</button>

  </div>
    <br><div class="container">
    
      <div class="left-column">      
    <div class="separaciones">
      
        <label for="txt_reporte">Reportar en el acta</label>
        <br>
        <input type="text" id="txt_reporte" class="text-boxpand" autocomplete="off">
        <br> <br> 
  
        <label for="pReportar">Emisor</label>
        <br>
        <select id="pReportar" class="list_profesional">
          <option value="">Selecciona</option>
          <option value="1">Anita</option>
          <option value="2">Meli</option>
          <option value="9">Pela</option>
          <option value="10">Eli</option>
          <option value="17">Marti, Admin</option>
          <option value="18">Marti, Prod. y Serv.</option>
          <option value="22">Cande</option>
          <option value="Si">Sil</option>
          <option value="29">Mari</option>
          <option value="30">Gabi</option>
          <option value="31">Dennis</option>
          <option value="Ja">Jari</option>
        </select>
        <input id="pReportarID" type="text" class="input_profesional" placeholder="...o por ID" maxlength="2" />
        <br>   
          <button type="button" id="btn_reportar" onclick="Reportar()" style="width:75px" disabled="true">Enviar</button>
   
      </div>

    <div class="separaciones">
      <h3> Servicio Compartido</h3>  
      <select id="pVendio_sc" class="list_profesional">
        <option value="">Selecciona</option>
        <option value="1">Anita</option>
        <option value="2">Meli</option>
        <option value="9">Pela</option>
        <option value="10">Eli</option>
        <option value="18">Marti, Prod. y Serv.</option>
        <option value="22">Cande</option>
        <option value="Si">Sil</option>
        <option value="29">Mari</option>
        <option value="30">Gabi</option>
        <option value="31">Dennis</option>
        <option value="Ja">Jari</option>
      </select>
      <input id="pVendioID" type="text" class="input_profesional" placeholder="ID" maxlength="2" style="width:50px"/>
      <label for="pVendioID">Quien lo vendió</label>
      <br>
      <select id="pHizo_sc" class="list_profesional">
        <option value="">Selecciona</option>
        <option value="1">Anita</option>
        <option value="2">Meli</option>
        <option value="9">Pela</option>
        <option value="10">Eli</option>
        <option value="18">Marti, Prod. y Serv.</option>
        <option value="22">Cande</option>
        <option value="Si">Sil</option>
        <option value="29">Mari</option>
        <option value="30">Gabi</option>
        <option value="31">Dennis</option>
        <option value="Ja">Jari</option>
      </select>
      <input id="pHizoID" type="text" class="input_profesional" placeholder="ID" maxlength="2" style="width:50px"/>
      <label for="pHizoID">Quien lo hizo</label>
      <br>
        <input type="text" id="txt_sc" class="text-box"> <label for="txt_sc">Servicio</label>
      <br>
        <input type="text" id="txt_Cliente_sc" class="text-box"> <label for="txt_Cliente_sc">Clienta</label>
      <br>
      <button type="button" id="btn_sc" onclick="servicioCompartido()" disabled="true" style="width:150px;margin:4px 0px">Cargar</button>
    </div>
  </div>
  <div class="right-column">
    <!-- Aquí puedes poner tus primeras cargas o dejarlo como espacio vacío por ahora -->
     <div class="separaciones">
      <pr>Ultimas Cargas en Acta</pr> <br>
      <div id="contenedorCeldas" class="tabla-acta">
      <div class="tabla-acta">
        <div class="celda-acta encabezado">Entrada</div>
        <div class="celda-acta encabezado">Profesional</div>
        <div class="celda-acta encabezado">Fecha</div>
        <div class="celda-acta encabezado">Hora</div>
      </div>
      </div>
     </div>
  </div>
</div>

</body>

<script async defer src="https://apis.google.com/js/api.js" id="gapi"></script>
<script async defer src="https://accounts.google.com/gsi/client" id="gis"></script>

<!--Autho-->
<script type="text/javascript">
      const CLIENT_ID = '975138822531-kc3rvpocfo6m56qh0mv50itfeko0udb8.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyBoAXvSua9gw0njTpFMuXmq13iJgruRrEE';
      const SHEETSID = '1JG6vntHGDJo5K5MkAahw1CDoXs656Sal_AyTWd1XyNM';
      const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
      const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      document.getElementById('gapi').addEventListener('load',gapiLoaded);
      document.getElementById('gis').addEventListener('load',gisLoaded);

      document.getElementById('authorize_button').style.display = 'inline';
      document.getElementById('signout_button').style.display = 'none';

      window.onload = function() {
        document.getElementById('authorize_button').innerText = 'Autorizar';
        document.getElementById('signout_button').style.display = 'none';
      };
   
      function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
      }

      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
        checkStoredToken();
      }

      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '', // defined later
        });
        gisInited = true;
        maybeEnableButtons();
        
      }

      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById('authorize_button').style.display = 'inline';
        }
      }
       
      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw (resp);
          }
          saveToken();
          onAuthSuccess();
        };

        if (gapi.client.getToken() === null) {
          // Prompt the user to select a Google Account and ask for consent to share their data
          // when establishing a new session.
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          // Skip display of account chooser and consent dialog for an existing session.
          tokenClient.requestAccessToken({prompt: ''});
        }
      }

      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          localStorage.removeItem('gapiToken'); // Elimina el token guardado
          onSignout();
        }
      }

      function saveToken() {
        const token = gapi.client.getToken();
        if (token) {
          localStorage.setItem('gapiToken', JSON.stringify(token));
        }
      }
      
      // Función para verificar y cargar el token guardado
      function checkStoredToken() {
        const savedToken = JSON.parse(localStorage.getItem('gapiToken'));
        if (savedToken) {
          gapi.client.setToken(savedToken);
          onAuthSuccess();
        }
      }

      async function onAuthSuccess() {
        await muestraDeActa();
        habilitarUso();
      }
      
      function onSignout() {
        document.getElementById('authorize_button').style.display = 'inline';
        document.getElementById('signout_button').style.display = 'none';
        document.getElementById('btn_reportar').disabled = true;
        document.getElementById('btn_sc').disabled = true;
      }

function habilitarUso(){
        document.getElementById('btn_reportar').disabled = false;
        document.getElementById('btn_sc').disabled = false;
        document.getElementById('signout_button').style.display = 'inline';
        document.getElementById('authorize_button').style.display = 'none';
  FlashPantalla("Conectado correctamente");
}

let PrimerPreview;

async function muestraDeActa() {
  let response;
  try {
    response = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEETSID,
      range: 'Acta Principal!A2:D', // Obtén todas las filas desde A2 hasta el final
    });
  } catch (err) {
    FlashPantalla("No pudo realizarse la conexión. Desvinculate y vuelve a solicitar Autorización");
    console.error(err);
    return;
  }

  const range = response.result;
  if (!range || !range.values || range.values.length === 0) {
    FlashPantalla("No hay entradas cargadas");
    console.warn("No hay entradas cargadas.");
    return;
  }
  // Tomar las últimas 5 filas
  const ultimasFilas = range.values.slice(-5);
  const contenedor = document.getElementById('contenedorCeldas');
  contenedor.innerHTML = ""; // Limpia el contenedor antes de agregar nuevos elementos

  // Crear encabezados (solo una vez)
  const encabezados = ['Entrada', 'Profesional', 'Fecha', 'Hora'];
  encabezados.forEach(texto => {
    const encabezadoCelda = document.createElement('div');
    encabezadoCelda.classList.add('celda-acta', 'encabezado');
    encabezadoCelda.textContent = texto;
    contenedor.appendChild(encabezadoCelda);
  });

  // Añadir las filas de datos
  ultimasFilas.forEach((fila) => {
    const entradaCelda = document.createElement('div');
    entradaCelda.classList.add('celda-acta');
    entradaCelda.textContent = fila[0];

    const profesionalCelda = document.createElement('div');
    profesionalCelda.classList.add('celda-acta');
    profesionalCelda.textContent = fila[1];

    const fechaCelda = document.createElement('div');
    fechaCelda.classList.add('celda-acta');
    fechaCelda.textContent = fila[2];

    const horaCelda = document.createElement('div');
    horaCelda.classList.add('celda-acta');
    horaCelda.textContent = fila[3];

    // Añadir las celdas al contenedor
    contenedor.appendChild(entradaCelda);
    contenedor.appendChild(profesionalCelda);
    contenedor.appendChild(fechaCelda);
    contenedor.appendChild(horaCelda);
  });
}

async function Reportar() {
  const txtReporte = document.getElementById('txt_reporte').value; // Obtener el valor
  const selectElement = document.getElementById('pReportar');
  const Professional = selectElement.selectedOptions[0].text;
  const fechaActual = new Date();
  const [fechaCorta, hora] = formatearFecha(fechaActual);

  // Verificar si los campos están vacíos
  if (!txtReporte || !Professional || Professional === "Selecciona") {
    FlashPantalla("Por favor, complete todos los campos antes de reportar.");
    return;
  }
  const actualizar = [
    txtReporte,
    Professional,
    fechaCorta,
    hora,
  ];

  try {
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: SHEETSID,
      range: 'Acta Principal!A:D', // Ajusta este rango según tu necesidad
      valueInputOption: 'USER_ENTERED',
      insertDataOption: 'INSERT_ROWS',
      resource: {
        values: [actualizar],
      },
    });
    FlashPantalla("Reporte Enviado con Exito");
    document.getElementById('pReportarID').value = '';
    document.getElementById('txt_reporte').value = '';
    document.getElementById('pReportar').value = '';
    muestraDeActa();
  } catch (err) {
    
    FlashPantalla("Error al enviar el reporte, reinicia la pagina o intente más tarde");
    console.error("Error al enviar el reporte:", err);
  }
}

async function servicioCompartido() {
  
  const pVendioSC = document.getElementById('pVendio_sc');
  const VendioSc = pVendioSC.selectedOptions[0].text;
  const pHizoSC = document.getElementById('pHizo_sc');
  const HizoSc = pHizoSC.selectedOptions[0].text;
  const ClienteSc = document.getElementById('txt_Cliente_sc').value;
  const Servicio = document.getElementById('txt_sc').value;
  const fechaActual = new Date();
  const [fechaCorta, hora] = formatearFecha(fechaActual);

  // Verificar si los campos están vacíos
  if (!HizoSc || !VendioSc || !ClienteSc  || !Servicio || !VendioSc === "Selecciona" || HizoSc === "Selecciona") {
    FlashPantalla("Por favor, complete todos los campos antes de reportar.");
    return;
  }
  const actualizar = [
    VendioSc,
    HizoSc,
    Servicio,
    fechaCorta,
    ClienteSc,
  ];

  try {
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: SHEETSID,
      range: 'Servicios Compartidos!A:E', // Ajusta este rango según tu necesidad
      valueInputOption: 'USER_ENTERED',
      insertDataOption: 'INSERT_ROWS',
      resource: {
        values: [actualizar],
      },
    });
    FlashPantalla("Servicio cargado con Exito");
    document.getElementById('pVendioID').value = '';
    document.getElementById('pVendio_sc').value = '';
    document.getElementById('pHizoID').value = '';
    document.getElementById('pHizo_sc').value = '';
    document.getElementById('txt_sc').value = '';
    document.getElementById('txt_Cliente_sc').value = '';
    muestraDeActa();
  } catch (err) {
    
    FlashPantalla("Error al enviar, Desvincula y Conecta nuevamente, o intente mas tarde");
    console.error("Error al cargar el SC:", err);
  }
}
function formatearFecha(fecha) {
  const dia = String(fecha.getDate()).padStart(2, '0');
  const mes = String(fecha.getMonth() + 1).padStart(2, '0'); // Los meses son indexados desde 0
  const año = fecha.getFullYear();
  const horas = String(fecha.getHours()).padStart(2, '0');
  const minutos = String(fecha.getMinutes()).padStart(2, '0');
  const segundos = String(fecha.getSeconds()).padStart(2, '0');
  
  return [`${dia}/${mes}/${año}`, `${horas}:${minutos}:${segundos}`];
}
</script>

<!--Personalizacion-->
<script type="text/javascript">
function checkOrientation() {
    const container = document.querySelector('.container');
    const leftColumn = document.querySelector('.left-column');
    const rightColumn = document.querySelector('.right-column');

    // Verifica si la pantalla está en modo horizontal
    if (window.innerWidth > window.innerHeight) {
        // Muestra la columna derecha en modo horizontal
        container.style.display = 'flex'; // o 'block' dependiendo de cómo quieras mostrarlo
        rightColumn.style.display = 'block'; // Muestra la columna derecha
        leftColumn.style.flex = '1';
    } else {
        // Oculta la columna derecha en modo vertical
        container.style.display = 'block';
        rightColumn.style.display = 'none'; // Oculta la columna derecha
        leftColumn.style.width = '100%';
    }
}
// Llama a la función al cargar la página
window.addEventListener('load', checkOrientation);

// Llama a la función cada vez que se redimensione la ventana
window.addEventListener('resize', checkOrientation);

//Auto adjust textboxes width
var input = document.querySelector('input'); // get the input element
input.addEventListener('input', resizeInput); // bind the "resizeInput" callback on "input" event
resizeInput.call(input); // immediately call the function
function resizeInput() {
  this.style.width = this.value.length + "ch";
}
      function FlashPantalla(message) {
        const flashMessage = document.getElementById('flash-message');
        flashMessage.textContent = message; // Cambiar el texto del mensaje
        flashMessage.classList.remove('flash-hidden'); // Mostrar el mensaje
        flashMessage.classList.add('flash-visible');
    
        // Ocultar el mensaje después de 3 segundos
        setTimeout(() => {
            flashMessage.classList.remove('flash-visible');
            flashMessage.classList.add('flash-hidden');
        }, 3000); // 3000 ms = 3 segundos
    }

    const profesionales = {
      '1': 'Anita',
      '2': 'Meli',
      '9': 'Pela',
      '10': 'Eli',
      '22': 'Cande',
      '17': 'Marti, Admin',
      '18': 'Marti, Prod y Servicios',
      'Si': 'Sil',
      '29': 'Mari',
      '30': 'Gabi',
      '31': 'Dennis',
      'Ja': 'Jari',
  };
  function handleAutocomplete(input) {
    const inputVal = input.value.trim(); // Obtiene el valor ingresado, eliminando espacios
    const select = input.previousElementSibling; // Obtiene el select anterior
    const nombre = profesionales[inputVal]; // Obtiene el nombre del profesional basado en el número

    if (nombre) {
        select.value = inputVal; // Actualiza el valor del select si hay coincidencia
    } else {
        select.value = ''; // Limpia el select si no hay coincidencia
    }
}

// Captura todos los inputs y les añade el evento
const inputs = document.querySelectorAll('.input_profesional');
inputs.forEach(input => {
    input.addEventListener('input', function() {
        handleAutocomplete(this);
    });
});
</script>
</html>
